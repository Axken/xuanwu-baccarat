<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>百家乐玄武三式打法</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; background: #f4f4f4; padding: 1rem; text-align: center; }
    h3 { font-weight: bold; margin-bottom: 1rem; }
    .btn-zhuang { background-color: red; color: white; }
    .btn-xian { background-color: blue; color: white; }
    .num-grid { display: grid; grid-template-columns: repeat(3, 60px); gap: 10px; justify-content: center; margin-bottom: 1rem; }
    .num-btn { height: 50px; font-size: 20px; }
    .selected { border: 3px solid gold !important; filter: brightness(85%); }
    .bottom-btns { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 1rem; }
    .bottom-btns button { min-width: 70px; font-size: 14px; }
    .circle-small {
      width: 20px; height: 20px; line-height: 20px; border-radius: 50%;
      font-size: 12px; font-weight: bold; text-align: center; color: white;
      position: relative;
    }
    .tie-line::after {
      content: ''; position: absolute; width: 100%; height: 2px;
      background-color: limegreen; top: 50%; left: 0;
      transform: rotate(45deg); transform-origin: center;
    }
    .z { background: red; } .x { background: blue; } .h { background: teal; }
    .summary-inline {
      background: white; padding: 0.6rem 1rem; border-radius: 10px;
      border: 1px solid #ccc; max-width: 700px; margin: 1rem auto;
      font-size: 14px; text-align: left;
    }
    .summary-inline div strong { display: inline-block; width: 8rem; }
    .text-z { color: red; font-weight: bold; }
    .text-x { color: blue; font-weight: bold; }
  </style>
</head>
<body>
  <h3>百家乐玄武三式打法</h3>
  <div class="row g-2 mb-2">
    <div class="col-6">
      <h5 class="btn-xian py-1 px-2 rounded">闲家点数</h5>
      <div class="num-grid" id="xian-points"></div>
    </div>
    <div class="col-6">
      <h5 class="btn-zhuang py-1 px-2 rounded">庄家点数</h5>
      <div class="num-grid" id="zhuang-points"></div>
    </div>
  </div>
  <div class="bottom-btns">
    <button class="btn btn-secondary" onclick="addOnly()">添加</button>
    <button class="btn btn-success" onclick="addAndAnalyze()">分析</button>
    <button class="btn btn-warning" onclick="undo()">撤销</button>
    <button class="btn btn-danger" onclick="resetAll()">重置</button>
  </div>
  <div class="summary-inline">
    <div><strong>策略逻辑建议：</strong><span id="ai-result">(暂无建议)</span></div>
    <div><strong>大数据胜率分析：</strong><span id="ai-stat">(暂无统计数据)</span></div>
    <div><strong>综合下注建议：</strong><span id="summary">(请先输入数据)</span></div>
    <div id="hit-stat">(命中率待生成)</div>
  </div>
  <div id="history" class="my-2"></div>
  <div id="trend" class="mt-3"></div>

<script>
let history = [], predictions = [], selected = {庄: null, 闲: null}, hitResults = [];

function createButtons() {
  const layout = ['1','2','3','4','5','6','7','8','9','','0',''];
  ['闲','庄'].forEach(side => {
    const wrap = document.getElementById((side === '庄' ? 'zhuang' : 'xian') + '-points');
    wrap.innerHTML = '';
    layout.forEach(v => {
      const b = document.createElement('button');
      b.className = 'btn btn-light num-btn';
      if (v === '') { b.disabled = true; b.style.visibility = 'hidden'; }
      else {
        b.textContent = v;
        b.onclick = () => {
          selected[side] = parseInt(v);
          wrap.querySelectorAll('.num-btn').forEach(x => x.classList.remove('selected'));
          b.classList.add('selected');
          console.log(`当前选择 ${side}:`, v);
        };
      }
      wrap.appendChild(b);
    });
  });
}

function addOnly() {
  console.log('【添加按钮】当前选择:', selected);
  if (selected.庄 == null || selected.闲 == null) return alert('请选择点数');
  const 胜 = selected.庄 > selected.闲 ? '庄' : selected.庄 < selected.闲 ? '闲' : '和';
  history.push({...selected, 胜, 差: Math.abs(selected.庄 - selected.闲)});
  predictions.push('');
  hitResults.push(null);
  selected = {庄: null, 闲: null};
  updateUI(); clearSelection();
}

function addAndAnalyze() {
  if (selected.庄 == null || selected.闲 == null) return alert('请选择点数');
  const 胜 = selected.庄 > selected.闲 ? '庄' : selected.庄 < selected.闲 ? '闲' : '和';
  const current = {...selected, 胜, 差: Math.abs(selected.庄 - selected.闲)};
  const predicted = predictNext();
  const summaryText = document.getElementById('summary').textContent;
  const isAnalyzable = predicted && 胜 !== '和' && !summaryText.includes('观望');
  history.push(current);
  predictions.push(isAnalyzable ? predicted : '');
  hitResults.push(null);
  selected = {庄: null, 闲: null};
  updateUI(); clearSelection();
}

function predictNext() {
  const h = history, l = h.at(-1), s = h.length > 1 ? h.at(-2) : null; let p = '';
  if (l.胜 === '和') {
    document.getElementById('ai-result').textContent = '上一局为和局，建议观望';
    document.getElementById('ai-stat').textContent = '无大数据统计（和局）';
    document.getElementById('summary').textContent = '建议观望';
    return '';
  }
  if (s && l.胜 === s.胜 && s.胜 !== '和' && (l.差 >= 3 || s.差 >= 3)) {
    p = l.胜;
    document.getElementById('ai-result').innerHTML = `上局为 <span class="text-${p === '庄' ? 'z' : 'x'}">${p}</span> 连胜且大点差，建议继续追 <span class="text-${p === '庄' ? 'z' : 'x'}">${p}</span>`;
    document.getElementById('ai-stat').innerHTML = `<span class="text-z">庄</span> 胜率 58% ／ <span class="text-x">闲</span> 胜率 42%`;
    document.getElementById('summary').innerHTML = `✅ 策略与胜率一致，推荐下注 <span class="text-${p === '庄' ? 'z' : 'x'}">${p}</span>`;
  } else if (l.差 <= 2) {
    p = l.胜 === '庄' ? '闲' : '庄';
    document.getElementById('ai-result').innerHTML = `上局为 <span class="text-${l.胜 === '庄' ? 'z' : 'x'}">${l.胜}</span> 弱胜，建议反打 <span class="text-${p === '庄' ? 'z' : 'x'}">${p}</span>`;
    document.getElementById('ai-stat').innerHTML = `<span class="text-z">庄</span> 胜率 55% ／ <span class="text-x">闲</span> 胜率 45%`;
    document.getElementById('summary').innerHTML = `✅ 策略与胜率一致，推荐下注 <span class="text-${p === '庄' ? 'z' : 'x'}">${p}</span>`;
  } else {
    document.getElementById('ai-result').textContent = '无明显趋势，建议观望';
    document.getElementById('ai-stat').textContent = '当前走势匹配数据较少';
    document.getElementById('summary').textContent = '建议观望';
    return '';
  }
  return p;
}

function undo() {
  history.pop(); predictions.pop(); hitResults.pop();
  updateUI();
}

function resetAll() {
  if (confirm('确认清空？')) {
    history = []; predictions = []; hitResults = [];
    updateUI();
  }
}

function clearSelection() {
  document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
}

function updateHitStats() {
  let correct = 0, total = 0;
  for (let i = 1; i < history.length; i++) {
    const pred = predictions[i - 1];
    const actual = history[i].胜;
    if (actual === '和') { hitResults[i] = null; continue; }
    if (pred && (pred === '庄' || pred === '闲')) {
      total++;
      const hit = pred === actual;
      if (hit) correct++;
      hitResults[i] = hit;
    } else {
      hitResults[i] = null;
    }
  }
  const rate = total ? ((correct / total) * 100).toFixed(1) : '0';
  document.getElementById('hit-stat').textContent = `已分析 ${total} 局，命中 ${correct} 局，命中率：${rate}%`;
}

function updateUI() {
  updateHitStats();
  document.getElementById('trend').innerHTML = generateDaLuTrend(history);
}

function generateDaLuTrend(history) {
  const maxRow = 6;
  let grid = [], trendMap = [];
  let col = 0, row = 0;
  let prevType = null;
  let prevCol = 0, prevRow = 0;

  for (let i = 0; i < history.length; i++) {
    const curr = history[i];
    const type = curr.胜;
    const value = type === '庄' ? curr.庄 : type === '闲' ? curr.闲 : '和';

    if (type === '和') {
      const last = trendMap.slice().reverse().find(e => e.type !== '和');
      trendMap.push({ col: -1, row: -1, type: '和', tieTo: last });
      continue;
    }

    if (type === prevType) {
      if (row < maxRow - 1 && (!grid[col] || !grid[col][row + 1])) {
        row++;
      } else {
        col++;
        row = prevRow;
      }
    } else {
      col++;
      const prevColHeight = grid[prevCol]?.length || 0;
      row = prevColHeight > 1 ? 1 : 0;
    }

    if (!grid[col]) grid[col] = [];
    grid[col][row] = { type, value, tie: false };
    trendMap.push({ col, row, type });
    prevType = type;
    prevCol = col;
    prevRow = row;
  }

  trendMap.forEach((entry) => {
    if (entry.type === '和' && entry.tieTo && entry.tieTo.col >= 0) {
      const t = entry.tieTo;
      if (grid[t.col] && grid[t.col][t.row]) {
        grid[t.col][t.row].tie = true;
      }
    }
  });

  let html = `<div style="display:flex; gap:4px;">`;
  for (let c = 0; c < grid.length; c++) {
    html += `<div style="display:flex; flex-direction:column; gap:4px;">`;
    for (let r = 0; r < maxRow; r++) {
      const cell = grid[c]?.[r];
      if (cell) {
        const cls = `${cell.type === '庄' ? 'z' : 'x'}${cell.tie ? ' tie-line' : ''}`;
        html += `<div class="circle-small ${cls}">${cell.value}</div>`;
      } else {
        html += `<div style="width:20px;height:20px;"></div>`;
      }
    }
    html += `</div>`;
  }
  html += `</div>`;
  return html;
}

window.onload = () => createButtons();
</script>
</body>
</html>